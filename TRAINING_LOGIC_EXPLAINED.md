# PatchSTG ä½¿ç”¨ ODPS æ•°æ®çš„å®Œæ•´è®­ç»ƒé€»è¾‘

## ðŸŽ¯ æ•´ä½“æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ•°æ®åŠ è½½é˜¶æ®µ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OdpsTableDataset è¯»å–ä¸»è¡¨                                  â”‚
â”‚  â†“                                                           â”‚
â”‚  åŠ è½½å…ƒæ•°æ®è¡¨ï¼ˆè·¯å£ç»çº¬åº¦ï¼‰                                  â”‚
â”‚  â†“                                                           â”‚
â”‚  æž„å»º location_dict: (nds_id, next_nds_id) â†’ (lat, lng)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Batch å¤„ç†é˜¶æ®µï¼ˆcollate_fnï¼‰                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç¬¬ä¸€ä¸ª batch åˆ°è¾¾                                           â”‚
â”‚  â†“                                                           â”‚
â”‚  æž„å»ºèŠ‚ç‚¹åˆ—è¡¨ï¼šæå–æ‰€æœ‰å”¯ä¸€çš„ (nds_id, next_nds_id)        â”‚
â”‚  â†“                                                           â”‚
â”‚  åˆ›å»º node_to_idx æ˜ å°„                                       â”‚
â”‚  â†“                                                           â”‚
â”‚  åˆ›å»º node_locations æ•°ç»„ï¼š(2, num_nodes) [çº¬åº¦, ç»åº¦]     â”‚
â”‚  â†“                                                           â”‚
â”‚  å¯¹æ¯æ¡è®°å½•ï¼š                                                â”‚
â”‚    - è§£æž time_feat â†’ (24, 6) â†’ æå– tod, dow              â”‚
â”‚    - è§£æž dym_feat_feat â†’ (24,) åŽ†å²æµé‡                   â”‚
â”‚    - æ ¹æ® node_to_idx æ‰¾åˆ°ç´¢å¼•                              â”‚
â”‚    - å¡«å……åˆ°å¯¹åº”ä½ç½®                                          â”‚
â”‚  â†“                                                           â”‚
â”‚  è¿”å›ž batch: {X, Y, TE}                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç©ºé—´ Patching é˜¶æ®µ                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä½¿ç”¨ node_locations è¿›è¡Œ KD-tree ç©ºé—´åˆ’åˆ†                  â”‚
â”‚  â†“                                                           â”‚
â”‚  é€’å½’åˆ†å‰²ï¼š                                                  â”‚
â”‚    - ç¬¬ 0 å±‚æŒ‰çº¬åº¦åˆ†å‰²                                       â”‚
â”‚    - ç¬¬ 1 å±‚æŒ‰ç»åº¦åˆ†å‰²                                       â”‚
â”‚    - ...ç›´åˆ°æ¯ä¸ª patch å¤§å° â‰¤ spa_patchsize                â”‚
â”‚  â†“                                                           â”‚
â”‚  å¾—åˆ° parts_idx: [[node0, node2, ...], [node1, node3, ...]]â”‚
â”‚  â†“                                                           â”‚
â”‚  ä½¿ç”¨é‚»æŽ¥çŸ©é˜µè¡¥é½ patchï¼ˆreorderDataï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ¨¡åž‹è®­ç»ƒé˜¶æ®µ                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  For each batch:                                            â”‚
â”‚    X: (batch, input_len, nodes, 1)                          â”‚
â”‚    Y: (batch, output_len, nodes, 1)                         â”‚
â”‚    TE: (batch, input_len, 2)                                â”‚
â”‚  â†“                                                           â”‚
â”‚  å½’ä¸€åŒ–ï¼šX_norm = (X - mean) / std                          â”‚
â”‚  â†“                                                           â”‚
â”‚  é€å…¥æ¨¡åž‹ï¼š                                                  â”‚
â”‚    - æ—¶é—´åµŒå…¥ï¼šTE â†’ temporal embeddings                     â”‚
â”‚    - ç©ºé—´åµŒå…¥ï¼šæŒ‰ patch åˆ†ç»„ï¼Œspatial attention             â”‚
â”‚    - æ—¶ç©ºèžåˆï¼špatch-wise processing                        â”‚
â”‚  â†“                                                           â”‚
â”‚  è¾“å‡ºé¢„æµ‹ï¼šY_pred                                            â”‚
â”‚  â†“                                                           â”‚
â”‚  è®¡ç®—æŸå¤±ï¼šloss = MSE(Y_pred, Y_norm)                       â”‚
â”‚  â†“                                                           â”‚
â”‚  åå‘ä¼ æ’­ + ä¼˜åŒ–                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ðŸ“Š è¯¦ç»†æ­¥éª¤è¯´æ˜Ž

### ç¬¬ 1 æ­¥ï¼šæ•°æ®åŠ è½½ (ODPSTableDataLoader.__init__)

**ç›®çš„**ï¼šåˆå§‹åŒ– ODPS è¿žæŽ¥ï¼ŒåŠ è½½å…ƒæ•°æ®è¡¨

**å…³é”®æ“ä½œ**ï¼š
```python
# 1.1 è¯»å–çŽ¯å¢ƒå˜é‡ä¸­çš„ ODPS å‡­è¯
access_id = os.getenv('ALIBABA_CLOUD_ACCESS_KEY_ID')
secret = os.getenv('ALIBABA_CLOUD_ACCESS_KEY_SECRET')

# 1.2 è¿žæŽ¥å…ƒæ•°æ®è¡¨ï¼ŒåŠ è½½ä½ç½®ä¿¡æ¯
query = "SELECT nds_id, next_nds_id, inter_id, lat, lng FROM intersection_meta_1"
# æž„å»ºå­—å…¸: location_dict[(nds_id, next_nds_id)] = {'lat': ..., 'lng': ...}

# ç¤ºä¾‹æ•°æ®ï¼š
# location_dict = {
#     (5068063879618101271, 5068063879618101309): {'inter_id': 'xxx', 'lat': 43.876, 'lng': 87.283},
#     (5068063879618101351, 5068063879618101273): {'inter_id': 'yyy', 'lat': 43.867, 'lng': 87.287},
#     ...
# }
```

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ çŽ¯å¢ƒå˜é‡ç¼ºå¤±
- âŒ å…ƒæ•°æ®è¡¨è¯»å–å¤±è´¥
- âŒ æŸäº›è½¬å‘æµç¼ºå°‘ä½ç½®ä¿¡æ¯

### ç¬¬ 2 æ­¥ï¼šåˆ›å»º DataLoader (create_dataloader)

**ç›®çš„**ï¼šåˆ›å»º PyTorch DataLoader

**å…³é”®æ“ä½œ**ï¼š
```python
# 2.1 åˆ›å»º OdpsTableDataset
odps_table = "odps://autonavi_traffic_report/tables/tb_inter_spatial_method_pretrain_data"
dataset = OdpsTableDataset(odps_table, slice_id=0, slice_count=1)

# 2.2 åˆ›å»º DataLoader
data_loader = DataLoader(
    dataset,
    batch_size=64,
    collate_fn=self._collate_fn,  # å…³é”®ï¼
    ...
)
```

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ è¡¨è·¯å¾„é”™è¯¯
- âŒ è¡¨ä¸­æ²¡æœ‰æ•°æ®ï¼ˆWHERE æ¡ä»¶è¿‡æ»¤æŽ‰äº†æ‰€æœ‰æ•°æ®ï¼‰

### ç¬¬ 3 æ­¥ï¼šç¬¬ä¸€ä¸ª Batch å¤„ç† (_collate_fn - é¦–æ¬¡è°ƒç”¨)

**ç›®çš„**ï¼šæž„å»ºå…¨å±€èŠ‚ç‚¹åˆ—è¡¨å’Œä½ç½®æ•°ç»„

**å…³é”®æ“ä½œ**ï¼š
```python
# 3.1 æ”¶é›†æ‰€æœ‰å”¯ä¸€çš„è½¬å‘æµ
node_set = set()
for record in batch:
    nds_id = record[0]
    next_nds_id = record[1]
    node_set.add((nds_id, next_nds_id))

# 3.2 åˆ›å»ºèŠ‚ç‚¹åˆ—è¡¨å’Œç´¢å¼•æ˜ å°„
self.node_list = [(n1, n2), ...]  # ä¾‹å¦‚ï¼š12392 ä¸ªèŠ‚ç‚¹
self.node_to_idx = {
    (5068063879618101271, 5068063879618101309): 0,
    (5068063879618101351, 5068063879618101273): 1,
    ...
}

# 3.3 åˆ›å»ºä½ç½®æ•°ç»„
self.node_locations = np.zeros((2, 12392), dtype=np.float32)
# node_locations[0, :] = çº¬åº¦æ•°ç»„ [43.876, 43.867, ...]
# node_locations[1, :] = ç»åº¦æ•°ç»„ [87.283, 87.287, ...]

for idx, (nds_id, next_nds_id) in enumerate(self.node_list):
    key = (nds_id, next_nds_id)
    if key in location_dict:
        self.node_locations[0, idx] = location_dict[key]['lat']
        self.node_locations[1, idx] = location_dict[key]['lng']
```

**æ•°æ®ç¤ºä¾‹**ï¼š
```
å‡è®¾ç¬¬ä¸€ä¸ª batch æœ‰ 64 æ¡è®°å½•ï¼Œæ¶‰åŠ 50 ä¸ªå”¯ä¸€è½¬å‘æµ

node_list = [
    (5068063879618101271, 5068063879618101309),  # idx=0
    (5068063879618101351, 5068063879618101273),  # idx=1
    ...
]  # é•¿åº¦ = 50

node_locations = [
    [43.876, 43.867, 43.859, ...],  # çº¬åº¦ï¼Œé•¿åº¦ 50
    [87.283, 87.287, 87.285, ...]   # ç»åº¦ï¼Œé•¿åº¦ 50
]
```

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ ç¬¬ä¸€ä¸ª batch å¤ªå°ï¼ŒèŠ‚ç‚¹æ•°ä¸è¶³
- âŒ æŸäº›èŠ‚ç‚¹ç¼ºå°‘ä½ç½®ä¿¡æ¯ï¼ˆlocation_dict ä¸­æ‰¾ä¸åˆ°ï¼‰
- âŒ node_locations å…¨æ˜¯ 0ï¼ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½ç¼ºä½ç½®ï¼‰

### ç¬¬ 4 æ­¥ï¼šè§£æžæ¯æ¡è®°å½• (_collate_fn - ä¸»å¾ªçŽ¯)

**ç›®çš„**ï¼šè§£æžå­—ç¬¦ä¸²ç‰¹å¾ï¼Œå¡«å……æ•°æ®æ•°ç»„

**å…³é”®æ“ä½œ**ï¼š
```python
# 4.1 åˆå§‹åŒ–è¾“å‡ºæ•°ç»„
batch_size = 64
input_len = 12
num_nodes = 50  # ä»Ž node_list å¾—åˆ°

X = np.zeros((64, 12, 50, 1), dtype=np.float32)
Y = np.zeros((64, 1, 50, 1), dtype=np.float32)
TE = np.zeros((64, 12, 2), dtype=np.float32)

# 4.2 éåŽ† batch ä¸­çš„æ¯æ¡è®°å½•
for i, record in enumerate(batch):  # i = 0 åˆ° 63
    nds_id = record[0]
    next_nds_id = record[1]
    flow_label = record[5]  # å½“å‰æ—¶åˆ»æµé‡
    time_feat_str = record[6]  # "5 17 36 0 18 8;5 17 35 0 18 8;..."
    dym_feat_str = record[7]   # "0;0;2;1;1;0;..."
    
    # 4.3 æŸ¥æ‰¾èŠ‚ç‚¹ç´¢å¼•
    node_idx = node_to_idx[(nds_id, next_nds_id)]  # ä¾‹å¦‚ï¼š3
    
    # 4.4 è§£æž time_feat
    # "5 17 36 0 18 8;5 17 35 0 18 8;..." â†’ (24, 6)
    time_array = [
        [5, 17, 36, 0, 18, 8],  # ç¬¬1ä¸ªæ—¶é—´æ­¥ï¼ˆå‰1åˆ†é’Ÿï¼‰
        [5, 17, 35, 0, 18, 8],  # ç¬¬2ä¸ªæ—¶é—´æ­¥ï¼ˆå‰2åˆ†é’Ÿï¼‰
        ...
    ]  # shape: (24, 6)
    
    # æå– tod å’Œ dow
    tod = time_array[:12, 1] / 24.0  # hour / 24ï¼Œå–å‰12æ­¥
    dow = time_array[:12, 0] / 7.0   # week / 7
    TE[i, :, 0] = tod  # (12,)
    TE[i, :, 1] = dow  # (12,)
    
    # 4.5 è§£æž dym_feat_feat
    # "0;0;2;1;1;0;..." â†’ [0, 0, 2, 1, 1, 0, ...]
    flow_array = [0, 0, 2, 1, 1, 0, ...]  # é•¿åº¦ 24
    
    # å–å‰ 12 ä¸ªä½œä¸ºè¾“å…¥
    X[i, :, node_idx, 0] = flow_array[:12]  # å¡«å……åˆ°èŠ‚ç‚¹ idx=3 çš„ä½ç½®
    
    # 4.6 å½“å‰æµé‡ä½œä¸ºæ ‡ç­¾
    Y[i, 0, node_idx, 0] = float(flow_label)
```

**æ•°æ®å¡«å……ç¤ºæ„å›¾**ï¼š
```
X æ•°ç»„ï¼š(batch_size=64, input_len=12, num_nodes=50, 1)

æ ·æœ¬ 0:
  æ—¶é—´æ­¥0  æ—¶é—´æ­¥1  ...  æ—¶é—´æ­¥11
  [                               ]  èŠ‚ç‚¹0: æ²¡æœ‰æ•°æ®ï¼Œå…¨0
  [0, 0, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0]  èŠ‚ç‚¹3: è¿™æ¡è®°å½•å¯¹åº”çš„èŠ‚ç‚¹
  [                               ]  èŠ‚ç‚¹1: æ²¡æœ‰æ•°æ®ï¼Œå…¨0
  ...

Y æ•°ç»„ï¼š(batch_size=64, output_len=1, num_nodes=50, 1)

æ ·æœ¬ 0:
  [0]     èŠ‚ç‚¹0: æ²¡æœ‰æ ‡ç­¾
  [0]     èŠ‚ç‚¹1: æ²¡æœ‰æ ‡ç­¾
  [0]     èŠ‚ç‚¹2: æ²¡æœ‰æ ‡ç­¾
  [1]     èŠ‚ç‚¹3: å½“å‰æµé‡ = 1
  ...
```

**æ³¨æ„**ï¼šè¿™æ˜¯ç¨€ç–å¡«å……ï¼æ¯ä¸ªæ ·æœ¬åªå¡«å……ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®ã€‚

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ time_feat æˆ– dym_feat_feat æ ¼å¼é”™è¯¯ï¼ˆåˆ†éš”ç¬¦ä¸å¯¹ï¼‰
- âŒ time_feat é•¿åº¦ä¸è¶³ 24
- âŒ dym_feat_feat é•¿åº¦ä¸è¶³ 12
- âŒ node_to_idx ä¸­æ‰¾ä¸åˆ°æŸä¸ªè½¬å‘æµ

### ç¬¬ 5 æ­¥ï¼šç©ºé—´ Patching (è®­ç»ƒè„šæœ¬ä¸­)

**ç›®çš„**ï¼šä½¿ç”¨ KD-tree å°†åœ°ç†ç›¸è¿‘çš„èŠ‚ç‚¹åˆ†ç»„

**å…³é”®æ“ä½œ**ï¼š
```python
from lib.utils import construct_adj, reorderData
from sklearn.neighbors import KDTree

# 5.1 ä½¿ç”¨ KD-tree æž„å»ºç©ºé—´ç´¢å¼•
tree = KDTree(node_locations.T)  # (50, 2)

# 5.2 é€’å½’åˆ†å‰²
def recursive_split(indices, depth=0):
    if depth >= recur_times or len(indices) <= spa_patchsize:
        return [indices]
    
    # æŒ‰çº¬åº¦æˆ–ç»åº¦åˆ†å‰²
    axis = depth % 2  # 0=çº¬åº¦, 1=ç»åº¦
    coords = node_locations[:, indices]
    median_idx = len(indices) // 2
    sorted_indices = indices[np.argsort(coords[axis, :])]
    
    left = sorted_indices[:median_idx]
    right = sorted_indices[median_idx:]
    
    return recursive_split(left, depth+1) + recursive_split(right, depth+1)

parts_idx = recursive_split(np.arange(50))

# ç»“æžœç¤ºä¾‹ï¼š
# parts_idx = [
#     [0, 2, 5, 8],      # Patch 0: è¥¿åŒ—åŒºåŸŸ
#     [1, 3, 7, 9],      # Patch 1: ä¸œåŒ—åŒºåŸŸ
#     [4, 6, 10, 11],    # Patch 2: å—éƒ¨åŒºåŸŸ
#     ...
# ]

# 5.3 è¡¥é½ patchï¼ˆä½¿ç”¨é‚»æŽ¥çŸ©é˜µï¼‰
adj = construct_adj(train_data, node_num)  # åŸºäºŽæµé‡ç›¸å…³æ€§
ori_parts_idx, reo_parts_idx, reo_all_idx = reorderData(parts_idx, max_len, adj, spa_patchsize)
```

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ node_locations å…¨æ˜¯ 0ï¼Œå¯¼è‡´åˆ†å‰²å¤±è´¥
- âŒ recur_times å¤ªå¤§ï¼Œpatch è¿‡å°
- âŒ sklearn æ²¡å®‰è£…

### ç¬¬ 6 æ­¥ï¼šæ¨¡åž‹è®­ç»ƒ (train loop)

**ç›®çš„**ï¼šä½¿ç”¨åˆ†å¥½çš„ patch è®­ç»ƒæ¨¡åž‹

**å…³é”®æ“ä½œ**ï¼š
```python
for epoch in range(epochs):
    for batch in data_loader:
        X = batch['X']   # (64, 12, 50, 1)
        Y = batch['Y']   # (64, 1, 50, 1)
        TE = batch['TE'] # (64, 12, 2)
        
        # 6.1 å½’ä¸€åŒ–
        X_norm = (X - mean) / std
        Y_norm = (Y - mean) / std
        
        # 6.2 é€å…¥æ¨¡åž‹
        # æ¨¡åž‹å†…éƒ¨ä¼šä½¿ç”¨ reo_parts_idx è¿›è¡Œ patch-wise å¤„ç†
        Y_pred = model(X_norm, TE, reo_parts_idx)
        
        # 6.3 è®¡ç®—æŸå¤±
        loss = criterion(Y_pred, Y_norm)
        
        # 6.4 åå‘ä¼ æ’­
        optimizer.zero_grad()
        loss.backward()
        optimizer.step()
```

**å¯èƒ½é—®é¢˜**ï¼š
- âŒ mean/std ä¸º NaNï¼ˆè®­ç»ƒæ•°æ®å…¨æ˜¯0ï¼‰
- âŒ Y_pred å½¢çŠ¶ä¸åŒ¹é…
- âŒ æ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±

## ðŸ” å…³é”®æ•°æ®æµ

### ç¤ºä¾‹ï¼šä¸€æ¡è®°å½•çš„å®Œæ•´æµç¨‹

```python
# åŽŸå§‹è®°å½•
record = [
    5068063879618101271,  # nds_id
    5068063879618101309,  # next_nds_id
    650100,               # adcode
    '20250919',           # ds
    '2025-09-19 17:37:00',# passts_time
    1,                    # flow_label (å½“å‰æµé‡)
    '5 17 36 0 18 8;5 17 35 0 18 8;...',  # time_feat (24æ®µ)
    '0;0;2;1;1;0;0;0;0;0;0;0;...'         # dym_feat_feat (24ä¸ªå€¼)
]

# æ­¥éª¤1: æŸ¥æ‰¾èŠ‚ç‚¹ç´¢å¼•
node_key = (5068063879618101271, 5068063879618101309)
node_idx = node_to_idx[node_key]  # å‡è®¾ = 3

# æ­¥éª¤2: æŸ¥æ‰¾ä½ç½®
location = location_dict[node_key]
# {'inter_id': 'xxx', 'lat': 43.876, 'lng': 87.283}

# æ­¥éª¤3: è§£æžæ—¶é—´ç‰¹å¾
time_feat_list = [
    [5, 17, 36, 0, 18, 8],  # å‰1åˆ†é’Ÿ: å‘¨äº” 17:36
    [5, 17, 35, 0, 18, 8],  # å‰2åˆ†é’Ÿ: å‘¨äº” 17:35
    ...
]
tod = [17/24, 17/24, ...]  # (12,)
dow = [5/7, 5/7, ...]      # (12,)

# æ­¥éª¤4: è§£æžåŽ†å²æµé‡
flow_feat_list = [0, 0, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0]  # å‰12åˆ†é’Ÿ

# æ­¥éª¤5: å¡«å……åˆ°æ•°ç»„
X[batch_idx, :, 3, 0] = [0, 0, 2, 1, 1, 0, 0, 0, 0, 0, 0, 0]
Y[batch_idx, 0, 3, 0] = 1
TE[batch_idx, :, 0] = [17/24, 17/24, ...]
TE[batch_idx, :, 1] = [5/7, 5/7, ...]
```

## âš ï¸ å¸¸è§é—®é¢˜å’Œæ–­è¨€ä½ç½®

### é—®é¢˜ 1: èŠ‚ç‚¹æ•°é‡ä¸ä¸€è‡´
**çŽ°è±¡**ï¼šä¸åŒ batch å‘çŽ°ä¸åŒçš„èŠ‚ç‚¹
**åŽŸå› **ï¼šèŠ‚ç‚¹åˆ—è¡¨åœ¨ç¬¬ä¸€ä¸ª batch æž„å»ºï¼ŒåŽç»­ batch å¯èƒ½æœ‰æ–°èŠ‚ç‚¹
**è§£å†³**ï¼šè¦ä¹ˆé¢„å…ˆæ‰«ææ‰€æœ‰æ•°æ®ï¼Œè¦ä¹ˆåŠ¨æ€æ‰©å±•

### é—®é¢˜ 2: ä½ç½®ä¿¡æ¯ç¼ºå¤±
**çŽ°è±¡**ï¼šnode_locations å…¨æ˜¯ 0
**åŽŸå› **ï¼šlocation_dict ä¸­æ²¡æœ‰å¯¹åº”çš„è½¬å‘æµ
**è§£å†³**ï¼šæ£€æŸ¥å…ƒæ•°æ®è¡¨çš„è¦†ç›–çŽ‡

### é—®é¢˜ 3: æ•°æ®ç¨€ç–
**çŽ°è±¡**ï¼šX å’Œ Y å¤§éƒ¨åˆ†æ˜¯ 0
**åŽŸå› **ï¼šæ¯ä¸ªæ ·æœ¬åªå¡«å……ä¸€ä¸ªèŠ‚ç‚¹
**è§£å†³**ï¼šè¿™æ˜¯æ­£å¸¸çš„ï¼æ¨¡åž‹éœ€è¦å¤„ç†ç¨€ç–æ•°æ®

### é—®é¢˜ 4: æ—¶é—´ç‰¹å¾è§£æžå¤±è´¥
**çŽ°è±¡**ï¼šTE å…¨æ˜¯ 0
**åŽŸå› **ï¼štime_feat æ ¼å¼é”™è¯¯æˆ–é•¿åº¦ä¸è¶³
**è§£å†³**ï¼šæ·»åŠ  try-except å’Œæ—¥å¿—

## ðŸ“ æ€»ç»“

æ•´ä¸ªæµç¨‹çš„æ ¸å¿ƒæ˜¯ï¼š
1. ä»Ž ODPS è¯»å–å­—ç¬¦ä¸²æ ¼å¼çš„åºåˆ—æ•°æ®
2. è§£æžæˆæ•°å€¼æ•°ç»„
3. é€šè¿‡èŠ‚ç‚¹ç´¢å¼•æ˜ å°„ï¼Œå¡«å……åˆ°ç¨€ç–çš„æ•°æ®å¼ é‡
4. ä½¿ç”¨ç»çº¬åº¦è¿›è¡Œç©ºé—´åˆ†ç»„
5. é€å…¥æ¨¡åž‹è®­ç»ƒ

å…³é”®ç‚¹ï¼š
- èŠ‚ç‚¹åˆ—è¡¨åœ¨ç¬¬ä¸€ä¸ª batch æ—¶ç¡®å®š
- æ•°æ®æ˜¯ç¨€ç–çš„ï¼ˆæ¯ä¸ªæ ·æœ¬åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹æœ‰å€¼ï¼‰
- ä½ç½®ä¿¡æ¯ç”¨äºŽç©ºé—´ patchingï¼Œä¸å‚ä¸Žè®­ç»ƒ
