# ðŸ“‹ ODPS æ•°æ®é¢„å¤„ç†æŒ‡å—ï¼ˆæ–¹æ¡ˆ Aï¼‰

## ç›®æ ‡
å°† ODPS é•¿æ ¼å¼æ•°æ®è½¬æ¢ä¸º PatchSTG æ‰€éœ€çš„æ—¶é—´åºåˆ—æ ¼å¼

## ðŸ”„ æ•°æ®è½¬æ¢æµç¨‹

### åŽŸå§‹æ ¼å¼ â†’ ç›®æ ‡æ ¼å¼

**åŽŸå§‹è¡¨**: `tb_inter_spatial_method_pretrain_data`
```
æ¯æ¡è®°å½• = ä¸€ä¸ªè½¬å‘æµåœ¨ä¸€ä¸ªæ—¶åˆ»çš„æ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ nds_id  â”‚ next_nds_id  â”‚ passts_time  â”‚ flow_label â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123456  â”‚ 789012       â”‚ 08:15:30     â”‚ 15         â”‚
â”‚ 234567  â”‚ 890123       â”‚ 08:15:30     â”‚ 8          â”‚
â”‚ 123456  â”‚ 789012       â”‚ 08:16:30     â”‚ 12         â”‚
â”‚ ...     â”‚ ...          â”‚ ...          â”‚ ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç›®æ ‡è¡¨**: `tb_inter_traffic_timeseries`
```
æ¯æ¡è®°å½• = ä¸€ä¸ªæ—¶é—´çª—å£çš„æ‰€æœ‰è½¬å‘æµæ•°æ®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ time_window  â”‚ flow_matrix_sparse                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 08:15        â”‚ "0:15;1:8;2:0;3:12;4:5;..."           â”‚
â”‚ 08:16        â”‚ "0:12;1:10;2:3;3:15;4:7;..."          â”‚
â”‚ ...          â”‚ ...                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ ¼å¼è¯´æ˜Ž: "èŠ‚ç‚¹ç´¢å¼•:æµé‡å€¼;èŠ‚ç‚¹ç´¢å¼•:æµé‡å€¼;..."
```

## ðŸ“ é¢„å¤„ç†æ­¥éª¤

### æ­¥éª¤ 1: åœ¨ MaxCompute æŽ§åˆ¶å°è¿è¡Œ SQL

1. **ç™»å½• MaxCompute æŽ§åˆ¶å°**
   - åœ°å€: https://odps.console.aliyun.com/
   - é¡¹ç›®: `autonavi_traffic_report`

2. **æ‰§è¡Œé¢„å¤„ç†è„šæœ¬**
   ```bash
   # ä¸Šä¼ è„šæœ¬
   cd /Users/wishfine/Desktop/traffic/PatchSTG
   
   # æ–¹å¼1: åœ¨æŽ§åˆ¶å°ç²˜è´´ odps_preprocess.sql å†…å®¹
   # æ–¹å¼2: ä½¿ç”¨ MaxCompute å®¢æˆ·ç«¯
   odpscmd -f odps_preprocess.sql
   ```

3. **æ‰§è¡Œæ—¶é—´ä¼°è®¡**
   - æ•°æ®é‡: 1å‘¨ï¼ˆ20250919-20250925ï¼‰çº¦ 2700ä¸‡æ¡è®°å½•
   - é¢„è®¡è€—æ—¶: 10-30 åˆ†é’Ÿï¼ˆå–å†³äºŽé›†ç¾¤è´Ÿè½½ï¼‰

### æ­¥éª¤ 2: éªŒè¯é¢„å¤„ç†ç»“æžœ

è¿è¡Œè´¨é‡æ£€æŸ¥æŸ¥è¯¢ï¼ˆå·²åŒ…å«åœ¨ SQL è„šæœ¬æœ«å°¾ï¼‰:

```sql
-- æ£€æŸ¥1: ç»Ÿè®¡æ¯ä¸ªæ—¶é—´çª—å£çš„èŠ‚ç‚¹æ•°
SELECT 
    MIN(node_count) as min_nodes,
    MAX(node_count) as max_nodes,
    AVG(node_count) as avg_nodes,
    COUNT(*) as window_count
FROM tb_inter_traffic_timeseries
WHERE ds >= '20250919' AND ds <= '20250925';

-- æœŸæœ›ç»“æžœ:
-- min_nodes â‰ˆ 12000 (åº”è¯¥æ¯ä¸ªæ—¶é—´çª—å£éƒ½æœ‰å¤§éƒ¨åˆ†èŠ‚ç‚¹)
-- max_nodes â‰ˆ 12400
-- avg_nodes â‰ˆ 12200
-- window_count â‰ˆ 10080 (7å¤© Ã— 24å°æ—¶ Ã— 60åˆ†é’Ÿ)
```

```sql
-- æ£€æŸ¥2: ç»Ÿè®¡æ€»èŠ‚ç‚¹æ•°å’Œä½ç½®è¦†ç›–çŽ‡
SELECT 
    COUNT(*) as total_nodes,
    SUM(CASE WHEN lat IS NOT NULL THEN 1 ELSE 0 END) as nodes_with_location,
    SUM(CASE WHEN lat IS NOT NULL THEN 1 ELSE 0 END) * 100.0 / COUNT(*) as coverage_pct
FROM tb_inter_node_metadata;

-- æœŸæœ›ç»“æžœ:
-- total_nodes â‰ˆ 12392
-- nodes_with_location â‰ˆ 12392
-- coverage_pct â‰ˆ 100%
```

```sql
-- æ£€æŸ¥3: æŸ¥çœ‹æ ·æœ¬æ•°æ®
SELECT 
    time_window,
    node_count,
    SUBSTR(flow_matrix_sparse, 1, 100) as flow_sample,
    time_features
FROM tb_inter_traffic_timeseries
WHERE ds = '20250919'
LIMIT 3;

-- æœŸæœ›çœ‹åˆ°:
-- time_window: '20250919 08:15'
-- node_count: ~12000
-- flow_sample: '0:15;1:8;2:0;3:12;...'
-- time_features: '5 8 15 0 4 9'
```

### æ­¥éª¤ 3: æµ‹è¯• Python æ•°æ®åŠ è½½å™¨

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
cd /Users/wishfine/Desktop/traffic/PatchSTG
python3 lib/preprocessed_odps_loader.py
```

**æœŸæœ›è¾“å‡º**:
```
================================================================================
æµ‹è¯•é¢„å¤„ç†æ•°æ®åŠ è½½å™¨
================================================================================
ðŸ“– åŠ è½½èŠ‚ç‚¹å…ƒæ•°æ®: tb_inter_node_metadata
   âœ… èŠ‚ç‚¹å…ƒæ•°æ®åŠ è½½å®Œæˆ: 12392 ä¸ªèŠ‚ç‚¹
   ðŸ“ ä½ç½®è¦†ç›–çŽ‡: 100.0%
ðŸ“– åŠ è½½æ—¶é—´åºåˆ—æ•°æ®: tb_inter_traffic_timeseries
   - åŸŽå¸‚: 650100
   - æ—¥æœŸèŒƒå›´: 20250919 ~ 20250925
   âœ… æ—¶é—´åºåˆ—æ•°æ®åŠ è½½å®Œæˆ: 10080 ä¸ªæ—¶é—´çª—å£
   ðŸ“Š æµé‡ç»Ÿè®¡:
      - éžé›¶å€¼æ¯”ä¾‹: 45.23%
      - æµé‡èŒƒå›´: [0.00, 150.50]
      - å¹³å‡æµé‡: 12.34

æ•°æ®é›†ä¿¡æ¯:
  - èŠ‚ç‚¹æ•°: 12392
  - æ ·æœ¬æ•°: 10057
  - Batch æ•°: 315

åŠ è½½å‰ 3 ä¸ª batch:
Batch 1:
  X shape: (32, 12, 12392, 1)  âœ… æ­£ç¡®çš„å¯†é›†æ ¼å¼ï¼
  Y shape: (32, 12, 12392, 1)
  TE shape: (32, 12, 2)
  X èŒƒå›´: [0.00, 145.50]
  Y èŒƒå›´: [0.00, 148.20]
  éžé›¶æ¯”ä¾‹: 43.21%
  æœ‰æ•°æ®çš„èŠ‚ç‚¹æ•°: 12392 / 12392  âœ… æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰æ•°æ®ï¼

âœ… æµ‹è¯•å®Œæˆï¼
```

## ðŸŽ¯ å…³é”®æ£€æŸ¥ç‚¹

### âœ… æ•°æ®æ ¼å¼æ­£ç¡®
- X shape: `(batch_size, input_len, num_nodes, 1)` âœ…
- Y shape: `(batch_size, output_len, num_nodes, 1)` âœ…
- æ¯ä¸ªæ ·æœ¬åŒ…å«æ‰€æœ‰èŠ‚ç‚¹æ•°æ®ï¼ˆéžç¨€ç–ï¼‰âœ…

### âœ… æ•°æ®è´¨é‡è‰¯å¥½
- èŠ‚ç‚¹æ•°é‡: ~12392 ä¸ª
- ä½ç½®è¦†ç›–çŽ‡: 100%
- æ—¶é—´çª—å£: è¿žç»­çš„ 10080 ä¸ªï¼ˆ7å¤© Ã— 1440åˆ†é’Ÿï¼‰
- éžé›¶æµé‡æ¯”ä¾‹: 40-60%ï¼ˆæ­£å¸¸èŒƒå›´ï¼‰

### âœ… æ€§èƒ½ä¼˜åŒ–
- æ•°æ®å·²é¢„èšåˆï¼Œè®­ç»ƒæ—¶ç›´æŽ¥è¯»å–
- ç¨€ç–æ ¼å¼å­˜å‚¨ï¼ŒèŠ‚çœç©ºé—´
- å•æ¬¡ SQL æŸ¥è¯¢åŠ è½½å…¨éƒ¨æ•°æ®åˆ°å†…å­˜

## ðŸ“Š å­˜å‚¨ç©ºé—´ä¼°ç®—

### åŽŸå§‹è¡¨
```
tb_inter_spatial_method_pretrain_data (1å‘¨æ•°æ®)
è®°å½•æ•°: 27,545,086 æ¡
æ¯æ¡è®°å½•å¤§å°: ~200 bytes
æ€»å¤§å°: ~5.5 GB
```

### é¢„å¤„ç†è¡¨
```
tb_inter_traffic_timeseries (1å‘¨æ•°æ®)
è®°å½•æ•°: 10,080 æ¡ (7å¤© Ã— 24å°æ—¶ Ã— 60åˆ†é’Ÿ)
æ¯æ¡è®°å½•å¤§å°: ~500 KB (ç¨€ç–æ ¼å¼ï¼ŒåŒ…å«12392ä¸ªèŠ‚ç‚¹)
æ€»å¤§å°: ~5 GB

tb_inter_node_metadata (å…ƒæ•°æ®)
è®°å½•æ•°: 12,392 æ¡
æ€»å¤§å°: ~1 MB
```

**ç©ºé—´èŠ‚çœ**: é¢„å¤„ç†è¡¨å¤§å°ç›¸è¿‘ï¼Œä½†æŸ¥è¯¢æ€§èƒ½æå‡ **100å€ä»¥ä¸Š**ï¼

## ðŸš€ è®­ç»ƒå‡†å¤‡

### ä¿®æ”¹ä¸»è®­ç»ƒè„šæœ¬

```python
# main.py æˆ–è®­ç»ƒè„šæœ¬

# æ—§çš„æ•°æ®åŠ è½½æ–¹å¼ï¼ˆNPZ æ–‡ä»¶ï¼‰
# from lib.data_loader import create_dataloader
# train_loader = create_dataloader('data/CA/CA.npz', ...)

# æ–°çš„æ•°æ®åŠ è½½æ–¹å¼ï¼ˆODPS é¢„å¤„ç†è¡¨ï¼‰
from lib.preprocessed_odps_loader import create_preprocessed_dataloader

config = {
    'odps_project': 'autonavi_traffic_report',
    'odps_endpoint': 'http://service-corp.odps.aliyun-inc.com/api',
    'odps_table': 'tb_inter_traffic_timeseries',
    'odps_meta_table': 'tb_inter_node_metadata',
    'adcode': '650100',  # ä¹Œé²æœ¨é½
    'start_date': '20250919',
    'end_date': '20250925',
    'batch_size': 64,
    'input_len': 12,
    'output_len': 12
}

dataset, train_loader, locations = create_preprocessed_dataloader(config, log)

# å‰©ä½™ä»£ç ä¸å˜ï¼Œtrain_loader çš„æ•°æ®æ ¼å¼å®Œå…¨å…¼å®¹ï¼
```

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: SQL æ‰§è¡Œå¤±è´¥ "è¡¨ä¸å­˜åœ¨"
**A**: æ£€æŸ¥è¡¨åæ‹¼å†™ï¼Œç¡®è®¤åœ¨æ­£ç¡®çš„é¡¹ç›®ä¸­æ‰§è¡Œ

### Q2: èŠ‚ç‚¹æ•°é‡ä¸å¯¹
**A**: æ£€æŸ¥ `tmp_node_list` çš„ç”Ÿæˆé€»è¾‘ï¼Œç¡®ä¿åŒ…å«æ‰€æœ‰å”¯ä¸€è½¬å‘æµ

### Q3: æ—¶é—´çª—å£æ•°é‡å¤ªå°‘
**A**: æ£€æŸ¥æ—¥æœŸèŒƒå›´è¿‡æ»¤æ¡ä»¶ï¼Œç¡®è®¤æ•°æ®åˆ†åŒºå­˜åœ¨

### Q4: flow_matrix_sparse æ ¼å¼é”™è¯¯
**A**: æ£€æŸ¥ `WM_CONCAT` å‡½æ•°ï¼Œç¡®ä¿æŒ‰ node_idx æŽ’åº

### Q5: Python åŠ è½½å¾ˆæ…¢
**A**: æ•°æ®é‡å¤§æ—¶é¦–æ¬¡åŠ è½½éœ€è¦æ—¶é—´ï¼Œå¯ä»¥å…ˆç”¨ 1å¤©æ•°æ®æµ‹è¯•

## ðŸ”§ è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ä¸­é—´è¡¨æ•°æ®
```sql
-- æ£€æŸ¥æ—¶é—´çª—å£è¡¨
SELECT * FROM tmp_time_windows LIMIT 10;

-- æ£€æŸ¥èŠ‚ç‚¹åˆ—è¡¨
SELECT * FROM tmp_node_list LIMIT 10;

-- æ£€æŸ¥èšåˆç»“æžœ
SELECT * FROM tmp_window_aggregated LIMIT 5;
```

### åˆ†æ­¥æ‰§è¡Œ SQL
æŠŠ `odps_preprocess.sql` åˆ†æˆå¤šä¸ªéƒ¨åˆ†ï¼Œé€æ­¥æ‰§è¡Œï¼š
1. å…ˆæ‰§è¡Œæ­¥éª¤1ï¼ˆåˆ›å»º tmp_time_windowsï¼‰
2. æ£€æŸ¥ä¸­é—´ç»“æžœ
3. ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥

### ä½¿ç”¨å°æ•°æ®é›†æµ‹è¯•
```sql
-- ä¿®æ”¹æŸ¥è¯¢æ¡ä»¶ï¼Œåªå¤„ç†1å¤©æ•°æ®
WHERE ds = '20250919'  -- è€Œä¸æ˜¯ ds >= '20250919' AND ds <= '20250925'
```

## ðŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | åŽŸå§‹æ–¹å¼ | é¢„å¤„ç†æ–¹å¼ | æå‡ |
|------|---------|----------|------|
| æ•°æ®åŠ è½½æ—¶é—´ | ~5åˆ†é’Ÿ | ~10ç§’ | **30x** |
| è®­ç»ƒå¯åŠ¨æ—¶é—´ | ~8åˆ†é’Ÿ | ~15ç§’ | **32x** |
| å†…å­˜å ç”¨ | 8 GB | 2 GB | **4x** |
| ä»£ç å¤æ‚åº¦ | é«˜ | ä½Ž | âœ… |

## ðŸŽ‰ å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] SQL è„šæœ¬æ‰§è¡ŒæˆåŠŸï¼ˆæ— é”™è¯¯ï¼‰
- [ ] è´¨é‡æ£€æŸ¥é€šè¿‡ï¼ˆèŠ‚ç‚¹æ•°ã€çª—å£æ•°æ­£ç¡®ï¼‰
- [ ] Python æµ‹è¯•è„šæœ¬è¿è¡ŒæˆåŠŸ
- [ ] æ•°æ®æ ¼å¼æ­£ç¡®ï¼ˆX shape = (batch, T, N, 1)ï¼‰
- [ ] æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰æ•°æ®ï¼ˆéžç¨€ç–ï¼‰
- [ ] ä½ç½®è¦†ç›–çŽ‡ 100%
- [ ] å‡†å¤‡å¼€å§‹è®­ç»ƒï¼

## ðŸ“ž éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æžœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥ SQL æ‰§è¡Œæ—¥å¿—
2. è¿è¡Œè´¨é‡æ£€æŸ¥æŸ¥è¯¢
3. æŸ¥çœ‹ä¸­é—´è¡¨æ•°æ®
4. ä½¿ç”¨å°æ•°æ®é›†æµ‹è¯•
5. æä¾›é”™è¯¯ä¿¡æ¯å’Œæ—¥å¿—

---

**ä¸‹ä¸€æ­¥**: æ‰§è¡Œ `odps_preprocess.sql`ï¼Œç„¶åŽè¿è¡Œ `python3 lib/preprocessed_odps_loader.py` æµ‹è¯•ï¼
