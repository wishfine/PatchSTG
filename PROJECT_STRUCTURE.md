# é¡¹ç›®ç»“æ„å›¾

## æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ•°æ®æº (Data Sources)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NPZ Files       â”‚              â”‚  ODPS Table         â”‚  â”‚
â”‚  â”‚  (æœ¬åœ°æ–‡ä»¶)       â”‚              â”‚  (MaxCompute)       â”‚  â”‚
â”‚  â”‚                  â”‚              â”‚                     â”‚  â”‚
â”‚  â”‚  - ca.npz        â”‚              â”‚  - tb_inter_       â”‚  â”‚
â”‚  â”‚  - gba.npz       â”‚              â”‚    spatial_        â”‚  â”‚
â”‚  â”‚  - gla.npz       â”‚              â”‚    method_         â”‚  â”‚
â”‚  â”‚  - sd.npz        â”‚              â”‚    pretrain_data   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                                   â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                   â”‚
            â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DataLoader          â”‚         â”‚   ODPSDataLoader           â”‚
â”‚   (lib/data_loader.py)â”‚         â”‚   (lib/odps_data_loader.py)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - load_data()         â”‚         â”‚ - _init_odps_client()      â”‚
â”‚ - get_train_data()    â”‚         â”‚ - _build_query()           â”‚
â”‚ - get_val_data()      â”‚         â”‚ - _parse_time_feat()       â”‚
â”‚ - get_test_data()     â”‚         â”‚ - _build_node_list()       â”‚
â”‚ - normalize_data()    â”‚         â”‚ - load_data()              â”‚
â”‚ - shuffle_train_data()â”‚         â”‚ - get_train_data()         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚       Solver               â”‚
            â”‚  (main.py / train_odps.py) â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ - build_model()            â”‚
            â”‚ - train()                  â”‚
            â”‚ - vali()                   â”‚
            â”‚ - test()                   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚      PatchSTG Model        â”‚
            â”‚    (models/model.py)       â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
            â”‚ - Spatial Patching         â”‚
            â”‚ - Temporal Patching        â”‚
            â”‚ - Depth Attention          â”‚
            â”‚ - Breadth Attention        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµè½¬æ¢

### NPZ æ•°æ®æµ
```
æœ¬åœ° NPZ æ–‡ä»¶
    â†“
loadData() (lib/utils.py)
    â†“
DataLoader
    â†“
Solver
    â†“
PatchSTG Model
```

### ODPS æ•°æ®æµ
```
ODPS Table
    â†“
SQL Query
    â†“
DataFrame (pandas)
    â†“
è§£æ time_feat, dym_feat_feat
    â†“
æ„å»ºèŠ‚ç‚¹åˆ—è¡¨
    â†“
æ»‘åŠ¨çª—å£ç”Ÿæˆæ ·æœ¬
    â†“
ODPSDataLoader
    â†“
ODPSSolver
    â†“
PatchSTG Model
```

## æ–‡ä»¶ç»„ç»‡

```
PatchSTG/
â”‚
â”œâ”€â”€ config/                      # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ CA.conf                  # åŠ å·æ•°æ®é…ç½®
â”‚   â”œâ”€â”€ GBA.conf                 # ç²¤æ¸¯æ¾³æ•°æ®é…ç½®
â”‚   â”œâ”€â”€ GLA.conf                 # æ´›æ‰çŸ¶æ•°æ®é…ç½®
â”‚   â”œâ”€â”€ SD.conf                  # åœ£åœ°äºšå“¥æ•°æ®é…ç½®
â”‚   â””â”€â”€ ODPS.conf                # ğŸ†• ODPS æ•°æ®é…ç½®
â”‚
â”œâ”€â”€ data/                        # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ CA/                      # åŠ å·æ•°æ®
â”‚   â”œâ”€â”€ GBA/                     # ç²¤æ¸¯æ¾³æ•°æ®
â”‚   â”œâ”€â”€ GLA/                     # æ´›æ‰çŸ¶æ•°æ®
â”‚   â””â”€â”€ SD/                      # åœ£åœ°äºšå“¥æ•°æ®
â”‚
â”œâ”€â”€ lib/                         # å·¥å…·åº“
â”‚   â”œâ”€â”€ utils.py                 # åŸæœ‰å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ data_loader.py           # ğŸ†• é€šç”¨æ•°æ®åŠ è½½å™¨
â”‚   â””â”€â”€ odps_data_loader.py      # ğŸ†• ODPS æ•°æ®åŠ è½½å™¨
â”‚
â”œâ”€â”€ models/                      # æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ model.py                 # PatchSTG æ¨¡å‹
â”‚
â”œâ”€â”€ log/                         # æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ ca_log
â”‚   â”œâ”€â”€ gba_log
â”‚   â”œâ”€â”€ gla_log
â”‚   â”œâ”€â”€ sd_log
â”‚   â””â”€â”€ odps_log                 # ğŸ†• ODPS è®­ç»ƒæ—¥å¿—
â”‚
â”œâ”€â”€ saved_models/                # ğŸ†• ä¿å­˜çš„æ¨¡å‹ï¼ˆéœ€åˆ›å»ºï¼‰
â”‚   â””â”€â”€ odps_model.pth           # ODPS è®­ç»ƒçš„æ¨¡å‹
â”‚
â”œâ”€â”€ main.py                      # åŸæœ‰ä¸»è„šæœ¬ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ train_odps.py                # ğŸ†• ODPS è®­ç»ƒè„šæœ¬
â”œâ”€â”€ quickstart_odps.py           # ğŸ†• å¿«é€Ÿå¼€å§‹è„šæœ¬
â”œâ”€â”€ check_odps_data.py           # ğŸ†• æ•°æ®æ£€æŸ¥è„šæœ¬
â”œâ”€â”€ preprocess_data.py           # ğŸ†• æ•°æ®é¢„å¤„ç†è„šæœ¬
â”œâ”€â”€ train_with_preloaded_data.py # ğŸ†• ä½¿ç”¨é¢„åŠ è½½æ•°æ®è®­ç»ƒ
â”‚
â”œâ”€â”€ README.md                    # ä¸»æ–‡æ¡£ï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ DATA_LOADER_README.md        # ğŸ†• æ•°æ®åŠ è½½å™¨æ–‡æ¡£
â”œâ”€â”€ ODPS_TRAINING_GUIDE.md       # ğŸ†• ODPS è®­ç»ƒæŒ‡å—
â””â”€â”€ SUMMARY.md                   # ğŸ†• ä¿®æ”¹æ€»ç»“
```

## ä½¿ç”¨æµç¨‹å›¾

### ä½¿ç”¨ NPZ æ•°æ®
```
1. ä¸‹è½½æ•°æ®
   â†“
2. é…ç½® config/CA.conf
   â†“
3. è¿è¡Œ python main.py --config config/CA.conf
   â†“
4. æŸ¥çœ‹ç»“æœ log/ca_log
```

### ä½¿ç”¨ ODPS æ•°æ®
```
1. è®¾ç½®ç¯å¢ƒå˜é‡ (ODPS å‡­è¯)
   â†“
2. è¿è¡Œ python quickstart_odps.py (æ£€æŸ¥ç¯å¢ƒ)
   â†“
3. é…ç½® config/ODPS.conf (è®¾ç½®åŸå¸‚ã€æ—¥æœŸ)
   â†“
4. è¿è¡Œ python check_odps_data.py (æ£€æŸ¥æ•°æ®)
   â†“
5. è¿è¡Œ python train_odps.py --config config/ODPS.conf --mode train
   â†“
6. æŸ¥çœ‹ç»“æœ log/odps_log
```

## æ•°æ®æ ¼å¼å¯¹æ¯”

### NPZ æ•°æ®
```python
{
    'X': np.ndarray,  # (num_samples, input_len, num_nodes, 1)
    'Y': np.ndarray,  # (num_samples, output_len, num_nodes, 1)
    'TE': np.ndarray, # æ—¶é—´ç‰¹å¾
}
```

### ODPS æ•°æ®ï¼ˆè¡¨ç»“æ„ï¼‰
```sql
CREATE TABLE tb_inter_spatial_method_pretrain_data (
    nds_id STRING,              -- èµ·å§‹èŠ‚ç‚¹
    next_nds_id STRING,         -- ç»ˆæ­¢èŠ‚ç‚¹
    adcode STRING,              -- åŸå¸‚ä»£ç 
    ds STRING,                  -- æ—¥æœŸåˆ†åŒº
    passts_time DATETIME,       -- æ—¶é—´æˆ³
    flow_label BIGINT,          -- æµé‡æ ‡ç­¾
    time_feat STRING,           -- æ—¶é—´ç‰¹å¾ (24æ®µ)
    dym_feat_feat STRING        -- åŠ¨æ€æµé‡ (24ä¸ªå€¼)
);
```

## æ¨¡å‹è®­ç»ƒæµç¨‹

```
æ•°æ®åŠ è½½
    â†“
æ•°æ®é¢„å¤„ç†
    â†“
æ¨¡å‹åˆå§‹åŒ–
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Epoch Loop     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Batch Loopâ”‚  â”‚
â”‚  â”‚  â†“        â”‚  â”‚
â”‚  â”‚ Forward   â”‚  â”‚
â”‚  â”‚  â†“        â”‚  â”‚
â”‚  â”‚ Loss      â”‚  â”‚
â”‚  â”‚  â†“        â”‚  â”‚
â”‚  â”‚ Backward  â”‚  â”‚
â”‚  â”‚  â†“        â”‚  â”‚
â”‚  â”‚ Update    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â†“              â”‚
â”‚  Validation     â”‚
â”‚  â†“              â”‚
â”‚  Save Best      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
æœ€ç»ˆæµ‹è¯•
    â†“
ä¿å­˜ç»“æœ
```

## å…³é”®ç±»å’Œæ–¹æ³•

### DataLoader (lib/data_loader.py)
```python
class DataLoader:
    def __init__(config, log)
    def load_data()              # åŠ è½½æ•°æ®
    def get_train_data()         # è·å–è®­ç»ƒæ•°æ®
    def get_val_data()           # è·å–éªŒè¯æ•°æ®
    def get_test_data()          # è·å–æµ‹è¯•æ•°æ®
    def shuffle_train_data()     # æ‰“ä¹±è®­ç»ƒæ•°æ®
    def normalize_data(data)     # å½’ä¸€åŒ–
    def denormalize_data(data)   # åå½’ä¸€åŒ–
    def get_data_info()          # è·å–æ•°æ®ä¿¡æ¯
```

### ODPSDataLoader (lib/odps_data_loader.py)
```python
class ODPSDataLoader:
    def __init__(config, log)
    def _init_odps_client()      # åˆå§‹åŒ– ODPS å®¢æˆ·ç«¯
    def _build_query()           # æ„å»º SQL æŸ¥è¯¢
    def _parse_time_feat(str)    # è§£ææ—¶é—´ç‰¹å¾
    def _parse_dym_feat(str)     # è§£æåŠ¨æ€æµé‡
    def _build_node_list(df)     # æ„å»ºèŠ‚ç‚¹åˆ—è¡¨
    def load_data()              # åŠ è½½æ•°æ®
    def get_train_data()         # è·å–è®­ç»ƒæ•°æ®
    # ... å…¶ä»–æ–¹æ³•åŒ DataLoader
```

### Solver (main.py)
```python
class Solver:
    def __init__(config, data_loader=None)
    def build_model()            # æ„å»ºæ¨¡å‹
    def train()                  # è®­ç»ƒ
    def vali()                   # éªŒè¯
    def test()                   # æµ‹è¯•
```

### ODPSSolver (train_odps.py)
```python
class ODPSSolver:
    def __init__(config, data_loader=None)
    def build_model()            # æ„å»ºæ¨¡å‹
    def train()                  # è®­ç»ƒ
    def vali()                   # éªŒè¯
    def test()                   # æµ‹è¯•
```

## é…ç½®å‚æ•°å±‚æ¬¡

```
config/ODPS.conf
    â”œâ”€â”€ [train]          # è®­ç»ƒå‚æ•°
    â”‚   â”œâ”€â”€ cuda
    â”‚   â”œâ”€â”€ seed
    â”‚   â”œâ”€â”€ batch_size
    â”‚   â”œâ”€â”€ max_epoch
    â”‚   â”œâ”€â”€ learning_rate
    â”‚   â””â”€â”€ weight_decay
    â”‚
    â”œâ”€â”€ [data]           # æ•°æ®å‚æ•°
    â”‚   â”œâ”€â”€ odps_project
    â”‚   â”œâ”€â”€ odps_endpoint
    â”‚   â”œâ”€â”€ odps_table
    â”‚   â”œâ”€â”€ adcode
    â”‚   â”œâ”€â”€ start_date
    â”‚   â”œâ”€â”€ end_date
    â”‚   â”œâ”€â”€ input_len
    â”‚   â”œâ”€â”€ output_len
    â”‚   â”œâ”€â”€ train_ratio
    â”‚   â”œâ”€â”€ val_ratio
    â”‚   â””â”€â”€ test_ratio
    â”‚
    â”œâ”€â”€ [param]          # æ¨¡å‹å‚æ•°
    â”‚   â”œâ”€â”€ layers
    â”‚   â”œâ”€â”€ tps, tpn    # æ—¶é—´ patch
    â”‚   â”œâ”€â”€ factors
    â”‚   â”œâ”€â”€ recur
    â”‚   â”œâ”€â”€ sps, spn    # ç©ºé—´ patch
    â”‚   â”œâ”€â”€ nodes
    â”‚   â”œâ”€â”€ tod, dow
    â”‚   â””â”€â”€ id, nd, td, dd  # åµŒå…¥ç»´åº¦
    â”‚
    â””â”€â”€ [file]           # æ–‡ä»¶è·¯å¾„
        â”œâ”€â”€ model
        â””â”€â”€ log
```

## ğŸ†• æ ‡è®°è¯´æ˜

- ğŸ†• = æ–°å¢æ–‡ä»¶æˆ–åŠŸèƒ½
- âœ… = å·²æµ‹è¯•åŠŸèƒ½
- âš ï¸ = éœ€è¦æ³¨æ„çš„äº‹é¡¹
- ğŸ“– = æ–‡æ¡£
- ğŸ”§ = é…ç½®
- ğŸš€ = æ€§èƒ½ä¼˜åŒ–
